# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mjjIVi6T2hHTcNWGXS7OeFe-FLMfz5sD
"""

import streamlit as st
import pandas as pd
import joblib
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, confusion_matrix, matthews_corrcoef

# Page Configuration
st.set_page_config(page_title="Mobile Price Classification", layout="wide")

# Title and Description
st.title("ðŸ“± Mobile Price Classification App")
st.markdown("""
This app predicts the price range of a mobile phone based on its specifications.
**Built for BITS Pilani M.Tech AI/ML Assignment 2.**
""")

# Sidebar for Model Selection
st.sidebar.header("Model Configuration")
model_options = [
    "Logistic Regression",
    "Decision Tree",
    "KNN",
    "Naive Bayes",
    "Random Forest",
    "XGBoost"
]
selected_model_name = st.sidebar.selectbox("Select ML Model", model_options)

# Load the selected model and scaler
@st.cache_resource
def load_resources(model_name):
    try:
        # Load Scaler
        scaler = joblib.load('models/scaler.pkl')

        # Load Model
        filename = f"models/{model_name.replace(' ', '_').lower()}.pkl"
        model = joblib.load(filename)
        return model, scaler
    except FileNotFoundError:
        st.error(f"Error: Model file '{filename}' or 'scaler.pkl' not found. Please ensure the 'models' folder is uploaded.")
        return None, None

model, scaler = load_resources(selected_model_name)

# Dataset Upload
st.header("1. Upload Test Dataset")
uploaded_file = st.file_uploader("Upload your CSV file (must contain mobile specs)", type=["csv"])

if uploaded_file is not None and model is not None:
    # Read CSV
    df = pd.read_csv(uploaded_file)
    st.write("### Data Preview")
    st.dataframe(df.head())

    # Preprocessing
    # We assume the uploaded file has the same columns as training data
    # Drop 'price_range' if it exists (Ground Truth) for prediction
    if 'price_range' in df.columns:
        X_test = df.drop('price_range', axis=1)
        y_true = df['price_range']
    else:
        X_test = df
        y_true = None

    # Scale data if needed (Logistic Regression & KNN used scaling)
    if selected_model_name in ["Logistic Regression", "KNN"]:
        try:
            X_test_processed = scaler.transform(X_test)
        except Exception as e:
            st.error(f"Error in data scaling: {e}")
            st.stop()
    else:
        X_test_processed = X_test

    # Button to Predict
    if st.button("Run Prediction"):
        prediction = model.predict(X_test_processed)
        df['Predicted_Price_Range'] = prediction

        st.write("### Prediction Results")
        st.dataframe(df[['Predicted_Price_Range']].head())

        # Display Metrics if Ground Truth is available
        if y_true is not None:
            st.header("2. Evaluation Metrics")

            col1, col2, col3 = st.columns(3)
            col4, col5 = st.columns(2)

            acc = accuracy_score(y_true, prediction)
            prec = precision_score(y_true, prediction, average='weighted')
            rec = recall_score(y_true, prediction, average='weighted')
            f1 = f1_score(y_true, prediction, average='weighted')
            mcc = matthews_corrcoef(y_true, prediction)

            col1.metric("Accuracy", f"{acc:.2f}")
            col2.metric("Precision", f"{prec:.2f}")
            col3.metric("Recall", f"{rec:.2f}")
            col4.metric("F1 Score", f"{f1:.2f}")
            col5.metric("MCC Score", f"{mcc:.2f}")

            # Confusion Matrix
            st.header("3. Confusion Matrix")
            cm = confusion_matrix(y_true, prediction)
            fig, ax = plt.subplots()
            sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', ax=ax)
            plt.xlabel('Predicted')
            plt.ylabel('Actual')
            st.pyplot(fig)
        else:
            st.warning("Ground truth ('price_range') not found in CSV. Metrics cannot be calculated.")