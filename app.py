# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mjjIVi6T2hHTcNWGXS7OeFe-FLMfz5sD
"""

import streamlit as st
import pandas as pd
import joblib
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, confusion_matrix, matthews_corrcoef, roc_auc_score

# 1. Basic Page Configuration
st.set_page_config(page_title="Mobile Price App", layout="wide")
st.title("ðŸ“± Mobile Price Classification")
st.markdown("---")

# 2. Sidebar for Cleaner UI
st.sidebar.header("Settings")
model_name = st.sidebar.selectbox("Select Model", ["Logistic Regression", "Decision Tree", "KNN", "Naive Bayes", "Random Forest", "XGBoost"])

# Load Scaler and Model
@st.cache_resource
def load_model_resources(name):
    try:
        model = joblib.load(f"models/{name.replace(' ', '_').lower()}.pkl")
        scaler = joblib.load('models/scaler.pkl')
        return model, scaler
    except:
        return None, None

model, scaler = load_model_resources(model_name)

# Download Button in Sidebar
try:
    with open("test_data.csv", "rb") as f:
        st.sidebar.download_button("ðŸ“¥ Download Test Data", f, "test_data.csv")
except:
    st.sidebar.warning("test_data.csv not found")

# 3. Main App logic
uploaded_file = st.file_uploader("Upload CSV file", type=["csv"])

if uploaded_file is not None and model is not None:
    df = pd.read_csv(uploaded_file)
    
    # --- TABLE 1: INITIAL INPUT DATA ---
    st.subheader("1. Input Data Preview")
    st.dataframe(df.head())

    # Preprocessing
    X = df.drop('price_range', axis=1) if 'price_range' in df.columns else df
    y_true = df['price_range'] if 'price_range' in df.columns else None

    # Prediction
    X_input = scaler.transform(X) if model_name in ["Logistic Regression", "KNN"] else X
    y_pred = model.predict(X_input)
    y_prob = model.predict_proba(X_input)

    # 4. Evaluation Metrics Section
    if y_true is not None:
        st.markdown("---")
        st.subheader("2. Model Metrics")
        
        # Displaying 6 metrics in a single row for a clean UI
        c1, c2, c3, c4, c5, c6 = st.columns(6)
        c1.metric("Accuracy", f"{accuracy_score(y_true, y_pred):.2f}")
        c2.metric("AUC", f"{roc_auc_score(y_true, y_prob, multi_class='ovr'):.2f}")
        c3.metric("Precision", f"{precision_score(y_true, y_pred, average='weighted'):.2f}")
        c4.metric("Recall", f"{recall_score(y_true, y_pred, average='weighted'):.2f}")
        c5.metric("F1 Score", f"{f1_score(y_true, y_pred, average='weighted'):.2f}")
        c6.metric("MCC", f"{matthews_corrcoef(y_true, y_pred):.2f}")

        # Confusion Matrix Visual
        st.write("#### Confusion Matrix")
        fig, ax = plt.subplots(figsize=(5, 3))
        sns.heatmap(confusion_matrix(y_true, y_pred), annot=True, fmt='d', cmap='Blues', cbar=False)
        st.pyplot(fig)

    # --- TABLE 2: FINAL PREDICTION RESULTS ---
    st.markdown("---")
    st.subheader("3. Prediction Results")
    res_df = df.copy()
    res_df.insert(0, 'Predicted_Range', y_pred)
    st.dataframe(res_df.head())

elif model is None:
    st.error("Model files missing in 'models/' folder.")
